<!DOCTYPE HTML>
<html>
	<head>
		<title>Velocity.js Tests</title>
		<link rel="stylesheet" href="qunit-1.14.0.css" type="text/css" media="screen" />
		<script type="text/javascript" src="qunit-1.14.0.js"></script>
		<script type="text/javascript" src="jquery-1.11.1.min.js"></script>
		<script type="text/javascript" src="../jquery.velocity.min.js"></script>
		<style>
			#details {
				margin: 0 auto;
				margin-bottom: 1em;

				width: 800px;
				padding: 0;

				line-height: 1.35em;
				list-style: none;
			}
		</style>
	</head>
	<body>
		<ul id="details">	
			<li>
				Unit tests: <i><b>current document</b>.</i>
			</li>
			<li>
				Performance tests: <i>See <b>Performance</b> pane in <a href="index.html#performance">docs</a>.</i>
			</li>
			<li>
				Property support tests: <i>Run the Property Support pane's <a href="index.html#propertiesTest">auto-cycler</a>.</i>
			</li>
			<li>
				Visual tests: <i>See <a href="demo.html"><b>demo</b></a>. Read demo's source for intended behavior.</i>
			</li>
		</ul>
		<div id="qunit"></div>
		<div id="qunit-stage"></div>
		<script>
		/*********************
		   Helper Functions
		*********************/

		/* IE detection: https://gist.github.com/julianshapiro/9098609 */
		var IE = (function() { 
		    if (document.documentMode) {
		        return document.documentMode;
		    } else {
		        for (var i = 7; i > 0; i--) {
		            var div = document.createElement("div");

		            div.innerHTML = "<!--[if IE " + i + "]><span></span><![endif]-->";

		            if (div.getElementsByTagName("span").length) {
		                div = null;

		                return i;
		            }

		            div = null;
		        }
		    }

		    return undefined;
		})();

    	var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

		/*********************
		   IE<=7 Reversion
		*********************/

  		if (IE <= 7 && $ && $.velocity) {
  			alert("Velocity wasn't reverted to jQuery's $.animate() for IE<=7.");
  		}

		/*******************
		   Setup: Targets
		*******************/

		var $qunitStage = $("#qunit-stage");

		var targetsFragment = document.createDocumentFragment(),
			targetsIndex = 0,
			$targets,
			$targetSet,
			defaultStyles = {
				opacity: 1,
				width: 1,
				height: 1,
				marginBottom: 1,
				colorGreen: 200
			};

		for (var i = 0; i < 100; i++) {
			var div = document.createElement("div");

			div.className = "target";
			div.style.opacity = defaultStyles.opacity;
			div.style.color = "rgb(125, " + defaultStyles.colorGreen + ", 125)";
			div.style.width = defaultStyles.width + "px";
			div.style.height = defaultStyles.height + "px";
			div.style.marginBottom = defaultStyles.marginBottom + "px";
			div.style.textShadow = "0px 0px " + defaultStyles.textShadowBlur + "px red";

			targetsFragment.appendChild(div);
			div = null;
		}

		$qunitStage.append(targetsFragment);
		$targets = $qunitStage.find(".target");

		function getTarget () {
			return $targets.eq(targetsIndex++);
		}

		/********************
		   Setup: Settings
		********************/

		var	pluginName = "velocity",
			defaultProperties = {
				opacity: defaultStyles.opacity / 2,
				width: defaultStyles.width * 2,
				colorGreen: defaultStyles.colorGreen / 2
			},
			defaultOptions = { 
				queue: "",
			    duration: 300,
			    easing: "swing",
			    complete: null,
			    display: null,
			    loop: false,
			    delay: false,
			    mobileHA: true,
			    _cacheValues: true
			},
			asyncCheckDuration = defaultOptions.duration / 2,
			completeCheckDuration = defaultOptions.duration * 1.75

		$.fn.velocity.defaults = defaultOptions;

		/****************
		    Arguments
		****************/

		QUnit.test("Arguments", function () {
			var testComplete = function() { /* Do nothing */ },
				testDuration = 1000,
				testEasing = "easeInSine",
				testOptions = {
					queue: defaultOptions.queue,
					duration: testDuration,
					easing: testEasing,
					complete: testComplete,
					display: "block",
					loop: false,
					delay: false,
					mobileHA: false,
			    	_cacheValues: defaultOptions._cacheValues
				};

			/**********************
			   Invalid Arguments
			**********************/

			var $target1 = getTarget();
			$target1
				/* No arguments: Ensure an error isn't thrown and that the $targeted elements are returned to the chain. */
				.velocity()
				.velocity({})
				.velocity({}, testDuration)
				/* Invalid arguments: Ensure an error isn't thrown. */
				.velocity("fakeArg1", "fakeArg2");

			/* Ensure that none of the above arguments triggered animation. */
			equal($target1.data(pluginName), undefined, "Invalid arguments.");

			/****************
			   Overloading
			****************/

			var $target2 = getTarget();
			$target2.velocity(defaultProperties, defaultOptions.duration);
			equal($target2.data(pluginName).opts.duration, defaultOptions.duration, "Overload variation #1.");

			var $target3 = getTarget();
			$target3.velocity(defaultProperties, testDuration);
			equal($target3.data(pluginName).opts.duration, testDuration, "Overload variation #2.");

			var $target4 = getTarget();
			$target4.velocity(defaultProperties, testEasing);
			equal($target4.data(pluginName).opts.easing, testEasing, "Overload variation #3.");

			var $target5 = getTarget();
			$target5.velocity(defaultProperties, testComplete);
			equal($target5.data(pluginName).opts.complete, testComplete, "Overload variation #4.");

			var $target6 = getTarget();
			$target6.velocity(defaultProperties, testDuration, testEasing);
			equal($target6.data(pluginName).opts.duration, testDuration, "Overload variation #5a.");
			equal($target6.data(pluginName).opts.easing, testEasing, "Overload variation #5b.");

			var $target7 = getTarget();
			$target7.velocity(defaultProperties, testDuration, testComplete);
			equal($target7.data(pluginName).opts.duration, testDuration, "Overload variation #6a.");
			equal($target7.data(pluginName).opts.complete, testComplete, "Overload variation #6b.");

			var $target8 = getTarget();
			$target8.velocity(defaultProperties, testDuration, testEasing, testComplete);
			equal($target8.data(pluginName).opts.duration, testDuration, "Overload variation #7a.");
			equal($target8.data(pluginName).opts.easing, testEasing, "Overload variation #7b.");
			equal($target8.data(pluginName).opts.complete, testComplete, "Overload variation #7c.");

			var $target9 = getTarget();
			$target9.velocity(defaultProperties, testOptions);
			deepEqual($target9.data(pluginName).opts, testOptions, "Overload variation #8.");

			/*********************
			   Utility Function
			*********************/

			var $target10 = getTarget();
			$.velocity.animate($target10[0], defaultProperties, testOptions);
			deepEqual($target10.data(pluginName).opts, testOptions, "Utility function variation #1.");

			var $target11 = getTarget();
			$.velocity.animate($target11[0], defaultProperties, testDuration, testEasing, testComplete);
			equal($target11.data(pluginName).opts.duration, testDuration, "Utility function variation #2a.");
			equal($target11.data(pluginName).opts.easing, testEasing, "Utility function variation #2b.");
			equal($target11.data(pluginName).opts.complete, testComplete, "Utility function variation #2c.");
		});

		/******************
		    CSS Object
		******************/

		/* Note: We don't bother checking all of the GET/SET-related CSS object's functions, as most are repeatedly tested indirectly via the other tests. */
		QUnit.test("CSS Object", function () {
			var CSS = $.velocity.CSS;

			var testHookRoot = "boxShadow",
				testHookRootValue = IE >=9 ? "1px 2px 3px 4px black" : "black 1px 2px 3px 4px",
				testHook = "boxShadowY",
				testHookValueExtracted = "2px",
				testHookValueInject = "10px",
				testHookRootValueInjected = "1px 10px 3px 4px"

			/* Hooks manipulation. */
			equal(CSS.Hooks.getRoot(testHook), testHookRoot, "Hooks.getRoot() returned root.");

			/* Hooks have no effect if they're unsupported (which is the case for our hooks on <=IE8), thus we just ensure that errors aren't thrown. */
			if (IE <=8) {
				CSS.Hooks.extractValue(testHook, testHookRootValue);
				CSS.Hooks.injectValue(testHook, testHookValueInject, testHookRootValue)
			} else {
				equal(CSS.Hooks.extractValue(testHook, testHookRootValue), testHookValueExtracted, "Hooks.extractValue() returned value #1.");
				/* Check for a match anywhere in the string since browser differ in where they inject the color value. */
				equal(CSS.Hooks.injectValue(testHook, testHookValueInject, testHookRootValue).indexOf(testHookRootValueInjected) != -1, true, "Hooks.extractValue() returned value #2.");
			}

			/* Varied start color formats. Ensure that all variations of red output contain the same color copmonents when Normalized: "255 0 0". */
			var redVariations = [
				"rgb(255, 0, 0)",
				"rgba(255,0,0,0.5)",
				"#ff0000",
				"red"
			];

			$.each(redVariations, function(i, redVariation) {
				equal(/255 0 0/.test(CSS.Normalizations.registered["color"]("extract", null, redVariation)), true, "Normalizations.extractValue() returned red color variation #" + i + ".");
			});

			var testPropertyFake = "fakeProperty";

			/* Property name functions. */
			equal(CSS.Names.prefixCheck(testPropertyFake)[0], testPropertyFake, "Names.prefixCheck() returned unmatched property untouched.");
			equal(CSS.Names.prefixCheck(testPropertyFake)[1], false, "Names.prefixCheck() indicated that unmatched property was unmatched.");
			equal(CSS.Values.isCSSNullValue("rgba(0,0,0,0)"), true, "Values.isCSSNullValue() matched null value #1.");
			equal(CSS.Values.isCSSNullValue("none"), true, "Values.isCSSNullValue() matched null value #2.");
			equal(CSS.Values.isCSSNullValue(10), false, "Values.isCSSNullValue() didn't match non-null value.");

			var testUnitProperty1 = "rotateZ",
				testUnitPropertyUnit1 = "deg",
				testUnitProperty2 = "width",
				testUnitPropertyUnit2 = "px",
				testElementType1 = document.createElement("div"),
				testElementTypeDisplay1 = "block",
				testElementType2 = document.createElement("span"),
				testElementTypeDisplay2 = "inline";

			/* CSS value functions. */
			equal(CSS.Values.getUnitType(testUnitProperty1), testUnitPropertyUnit1, "Unit type #1 was retrieved.");
			equal(CSS.Values.getUnitType(testUnitProperty2), testUnitPropertyUnit2, "Unit type #2 was retrieved.");
			equal(CSS.Values.getDisplayType(testElementType1), testElementTypeDisplay1, "Display type #1 was retrieved.");
			equal(CSS.Values.getDisplayType(testElementType2), testElementTypeDisplay2, "Display type #2 was retrieved.");
		});

		/****************************
		   Start Value Calculation
		****************************/

		QUnit.test("Start Value Calculation", function () {
			var testStartValues = { paddingLeft: "10px", height: "20px", lineHeight: "30px", wordSpacing: "40px", backgroundColorRed: "123" };

			/* Properties not previously defined on the element. */
			var $target1 = getTarget();
			$target1.velocity(testStartValues)
			equal($target1.data(pluginName).tweensContainer.paddingLeft.startValue, 0, "Undefined standard start value was calculated.");
			equal($target1.data(pluginName).tweensContainer.backgroundColorRed.startValue, 255, "Undefined start value hook was calculated.");

			/* Properties previously defined on the element. */
			var $target2 = getTarget();
			$target2.velocity(defaultProperties)
			equal($target2.data(pluginName).tweensContainer.width.startValue, parseFloat(defaultStyles.width), "Defined start value #1 was calculated.");
			equal($target2.data(pluginName).tweensContainer.opacity.startValue, parseFloat(defaultStyles.opacity), "Defined start value #2 was calculated.");
			equal($target2.data(pluginName).tweensContainer.colorGreen.startValue, parseFloat(defaultStyles.colorGreen), "Defined hooked start value was calculated.");

			/* Properties that shouldn't cause start values to be unit-converted. */
			var testPropertiesEndNoConvert = { paddingLeft: "20px", height: "40px" };
			var $target3 = getTarget();
			$target3
				.css(testStartValues)
				.velocity(testPropertiesEndNoConvert)
			equal($target3.data(pluginName).tweensContainer.paddingLeft.startValue, parseFloat(testStartValues.paddingLeft), "Start value #1 wasn't unit converted.");
			equal($target3.data(pluginName).tweensContainer.height.startValue, parseFloat(testStartValues.height), "Start value #2 wasn't unit converted.");

			/* Properties that should cause start values to be unit-converted. */
			var testPropertiesEndConvert = { paddingLeft: "20%", height: "40%", lineHeight: "0.5em", wordSpacing: "2rem" };
				parentWidth = $qunitStage.width(),
				parentHeight = $qunitStage.height(),
				parentFontSize = $qunitStage.css("fontSize"),
				remSize = parseFloat($.css(document.body, "fontSize"));

			var $target4 = getTarget();
			$target4
				.css(testStartValues)
				.velocity(testPropertiesEndConvert);

			/* Long decimal results can be returned after unit conversion, and Velocity's code and the code here can differ in precision. So, we round floor values before comparison. */
			equal(Math.floor($target4.data(pluginName).tweensContainer.paddingLeft.startValue), Math.floor((parseFloat(testStartValues.paddingLeft) / parentWidth) * 100), "Horizontal property converted to %.");
			equal(Math.floor($target4.data(pluginName).tweensContainer.height.startValue), Math.floor((parseFloat(testStartValues.height) / parentHeight) * 100), "Vertical property converted to %.");
			equal(Math.floor($target4.data(pluginName).tweensContainer.lineHeight.startValue), Math.floor(parseFloat(testStartValues.lineHeight) / parseFloat(parentFontSize)), "Property converted to em.");
			equal(Math.floor($target4.data(pluginName).tweensContainer.wordSpacing.startValue), Math.floor(parseFloat(testStartValues.wordSpacing) / parseFloat(remSize)), "Property converted to rem.");

  			/* jQuery TRBL deferring. */
			var testPropertiesTRBL = { left: "1000px" };
  			$("<div id='TRBL_Container' style='margin-left: " + testPropertiesTRBL.left + "; width: 100; height: 100'></div>").appendTo($("body"));

			var $target5 = getTarget();
			$target5
				.css({ position: "absolute" })
				.appendTo($("#TRBL_Container"))
				.velocity(testPropertiesTRBL);

			equal($target5.data(pluginName).tweensContainer.left.startValue, parseFloat(testPropertiesTRBL.left) + parseFloat($("body").css("marginLeft")), "TRBL value was deferred to jQuery.");
		});

		/**************************
		   End Value Calculation
		**************************/

		QUnit.asyncTest("End Value Calculation", function () {
			/* Standard properties without operators. */
			var $target1 = getTarget();
			$target1.velocity(defaultProperties);
			setTimeout(function() {
				equal($target1.data(pluginName).tweensContainer.width.endValue, defaultProperties.width, "Standard end value #1 was calculated.");
				equal($target1.data(pluginName).tweensContainer.opacity.endValue, defaultProperties.opacity, "Standard end value #2 was calculated.");
			}, asyncCheckDuration);

			/* Standard properties with operators. */
			var testIncrementWidth = "5px",
				testDecrementOpacity = 0.25,
				testMultiplyMarginBottom = 4,
				testDivideHeight = 2;

			var $target2 = getTarget();
			$target2.velocity({ width: "+=" + testIncrementWidth, opacity: "-=" + testDecrementOpacity, marginBottom: "*=" + testMultiplyMarginBottom, height: "/=" + testDivideHeight });
			setTimeout(function() {

				equal($target2.data(pluginName).tweensContainer.width.endValue, defaultStyles.width + parseFloat(testIncrementWidth), "Incremented end value was calculated.");
				equal($target2.data(pluginName).tweensContainer.opacity.endValue, defaultStyles.opacity - testDecrementOpacity, "Decremented end value was calculated.");
				equal($target2.data(pluginName).tweensContainer.marginBottom.endValue, defaultStyles.marginBottom * testMultiplyMarginBottom, "Multiplied end value was calculated.");
				equal($target2.data(pluginName).tweensContainer.height.endValue, defaultStyles.height / testDivideHeight, "Divided end value was calculated.");

				start();
			}, asyncCheckDuration);
		});

		/**********************
		   End Value Setting
		**********************/

		QUnit.asyncTest("End Value Setting (Note: Browser Tab Must Have Focus Due to RAF)", function () {
			/* Transforms and the properties that are hooked by Velocity aren't supported below IE9. */
			if (!(IE < 9)) {
				var testHooks = { 
					boxShadowBlur: "10px", // "black 0px 0px 10px 0px"
					boxShadowSpread: "20px", // "black 0px 0px 0px 20px"
					textShadowBlur: "30px" // "black 0px 0px 30px"
				};

				/* Hooks. */
				var $target3 = getTarget();
				$target3.velocity(testHooks);
				setTimeout(function() {
					/* Check for a match anywhere in the string since browser differ in where they inject the color value. */
					equal(/0px 0px 10px 20px/.test($target3.css("boxShadow")), true, "Hook end value #1 was set.");
					/* textShadow isn't supported below IE10. */
					if (IE >= 10) {
						equal(/0px 0px 30px/.test($target3.css("textShadow")), true, "Hook end value #2 was set.");
					}
				}, completeCheckDuration);

				if (!(IE < 10)) {
					var testTransforms = { 
							translateY: "10em", // Should stay the same
							translateX: "20px", // Should stay the same
							scaleX: "1.50", // Should remain unitless
							translateZ: "30", // Should become "10px"
							scaleY: "1.50deg" // Should be ignored entirely since it uses an invalid unit
						},
						testTransformsOutput = "matrix3d(1.5, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 20, 160, 30, 1)";

					/* Transforms. */
					var $target4 = getTarget();
					$target4.velocity(testTransforms);
					setTimeout(function() {
						/* Check for a match anywhere in the string since browser differ in where they inject the color value. */
						equal($target4.css("transform"), testTransformsOutput, "Transform end value was set.");

						/* Ensure previous transform values are reused. */
						$target4.velocity({ translateX: parseFloat(testTransforms.translateX) / 2 });
						equal($target4.data(pluginName).tweensContainer.translateX.startValue, parseFloat(testTransforms.translateX), "Previous transform value was reused.");
					}, completeCheckDuration);
				}
			}

			/* Standard properties. */
			var $target1 = getTarget();
			$target1.velocity(defaultProperties, { });
			setTimeout(function() {
				equal(parseFloat($target1.css("width")), defaultProperties.width, "Standard end value #1 was set.");
				equal(parseFloat($target1.css("opacity")), defaultProperties.opacity, "Standard end value #2 was set.");

				start();
			}, completeCheckDuration);
		});

		/**********************
		   End Value Caching
		**********************/

		QUnit.asyncTest("End Value Caching", function () {
			expect(4);

			var newProperties = { opacity: 1, width: 250 };

			var $target1 = getTarget();
			$target1.velocity(defaultProperties, function() {
				$target1
					.css(newProperties)
					/* Called after the last call is complete (stale). Ensure that the newly-set (via $.css()) properties are used. */
					.velocity(defaultProperties);

					setTimeout(function() {
						equal($target1.data(pluginName).tweensContainer.width.startValue, newProperties.width, "Stale end value #1 wasn't pulled.");
						equal($target1.data(pluginName).tweensContainer.opacity.startValue, newProperties.opacity, "Stale end value #2 wasn't pulled.");
					}, asyncCheckDuration);
			});

			var $target2 = getTarget();
			$target2
				.velocity(defaultProperties)
				.velocity(newProperties, function() {
					/* Chained onto a previous call (fresh). */
					equal($target2.data(pluginName).tweensContainer.width.startValue, defaultProperties.width, "Chained end value #1 was pulled.");
					equal($target2.data(pluginName).tweensContainer.opacity.startValue, defaultProperties.opacity, "Chained end value #2 was pulled.");

					start();
				});
		});

		/****************
		    Queueing
		****************/

		QUnit.asyncTest("Queueing", function () {
			expect(1);

			var $target1 = getTarget();
			$target1
				.velocity({ opacity: 0 })
				.velocity({ width: 2 })

			setTimeout(function() {
				/* Ensure that the second call hasn't started yet. */
				equal($target1.width(), defaultStyles.width, "Queued calls chain.");

				start();
			}, asyncCheckDuration);
		});

		/******************
		   Option: Queue
		******************/

		/* Todo: Create tests for custom queues across all features (reverse, loop, etc.) */
		QUnit.asyncTest("Option: Queue", function () {
			expect(5);

			var testQueue = "custom";

			var $target1 = getTarget();
			$target1
				.velocity(defaultProperties, { queue: testQueue })
				.velocity(defaultProperties, { queue: testQueue })
				.velocity(defaultProperties, { queue: testQueue });

			equal($target1.queue(testQueue).length, 3, "Custom queue was appended to.");
			equal($target1.data(pluginName).isAnimating, false, "Custom queue didn't auto-dequeue.");

			$target1.dequeue(testQueue);
			equal($target1.data(pluginName).isAnimating, true, "Dequeue custom queue.");

			$target1.velocity("stop", testQueue);
			equal($target1.queue(testQueue).length, 0, "Stopped custom queue.");

			var $target2 = getTarget();
			$target2
				.velocity({ opacity: 0 })
				.velocity({ width: 10 }, { queue: false });

			setTimeout(function() {
				/* Ensure that the second call starts immediately. */
				notEqual($target2.width(), defaultStyles.width, "Parallel calls don't queue.");

				start();
			}, asyncCheckDuration);
		});

		/* Helpful sequence for testing custom and parallel queues. */
		// var $div2 = $("#dataBody-PropertiesDummy");
		// $.fn.velocity.defaults.duration = 1000;
		// $div2.velocity("scroll", { queue: "test" })
		// $div2.velocity({width: 100}, { queue: "test" })
		// $div2.velocity({ borderWidth: 50 }, { queue: "test" })
		// $div2.velocity({height: 20}, { queue: "test" })
		// $div2.velocity({marginLeft: 200}, { queue: "test" })
		// $div2.velocity({paddingTop: 60});
		// $div2.velocity({marginTop: 100});
		// $div2.velocity({paddingRight: 40});
		// $div2.velocity({marginTop: 0})
		// $div2.dequeue("test")

		/******************
		   Option: Delay   
		******************/

		QUnit.asyncTest("Option: Delay (Note: Browser Tab Must Have Focus Due to RAF)", function () {
			expect(2);

			var testDelay = defaultOptions.duration * 2;

			var $target = getTarget();
			$target.velocity(defaultProperties, { delay: testDelay });

			setTimeout(function() {
				equal($target.width(), defaultStyles.width, "Delayed calls don't start immediately");
			}, asyncCheckDuration);

			setTimeout(function() {
				equal($target.width(), defaultProperties.width, "Delayed calls eventually start.");

				start();
			}, completeCheckDuration + testDelay);
		});

		/********************
		   Option: Easing   
		********************/

		QUnit.asyncTest("Option: Easing", function () {
			expect(3);

			var $target1 = getTarget();
			/* Ensure that a fake easing doesn't throw an error. */
			$target1.velocity(defaultProperties, { easing: "fake" });
			equal(true, true, "Fake easing didn't throw error.");

			/* Ensure that an improperly-formmated bezier curve array doesn't throw an error. */
			var $target2 = getTarget();
			$target2
				.velocity(defaultProperties, { easing: [ "a", 0.5, 0.5, 0.5 ] })
				.velocity(defaultProperties, { easing: [ 0.5, 0.5, 0.5 ] });

			equal(true, true, "Invalid bezier curve didn't throw error.");

			/* Ensure that a properly-formatted bezier curve array returns a bezier function. */
			var $target3 = getTarget();
			var easingBezierArray = [ 0.27, -0.65, 0.78, 0.19 ],
				easingBezierTestPercent = 0.25,
				easingBezierTestValue = /^-0\.23/;

			$target3.velocity(defaultProperties, { easing: easingBezierArray });
			setTimeout(function() {
				equal(easingBezierTestValue.test($target3.data(pluginName).tweensContainer.width.easing(easingBezierTestPercent)), true, "Array converted into bezier function.");

				start();
			}, asyncCheckDuration);
		});

		/********************
		   Option: Display   
		********************/

		QUnit.asyncTest("Option: Display", function () {
			var testDisplayBlock = "block",
				testDisplayNone = "none";

			var $target1 = getTarget();
			/* Async checks are used since the display property is set inside processCallsTick(). */
			$target1.velocity(defaultProperties, { display: testDisplayBlock });
			setTimeout(function() {
				equal($target1.css("display"), testDisplayBlock, "Display:'block' was set immediately.");
			}, asyncCheckDuration);

			var $target2 = getTarget();
			$target2.velocity(defaultProperties, { display: testDisplayNone });
			setTimeout(function() {
				notEqual($target2.css("display"), testDisplayNone, "Display:'none' was not set immediately.");
			}, asyncCheckDuration);
			setTimeout(function() {
				equal($target2.css("display"), testDisplayNone, "Display:'none' was set upon completion.");

				start();
			}, completeCheckDuration);
		});

		/******************
		   Option: Loop
		******************/

		QUnit.asyncTest("Option: Loop", function () {
			expect(2);

			var testDelay = 500;

			var $target1 = getTarget();
			$target1.velocity(defaultProperties, { loop: 2, delay: testDelay });

			/* We expect 1 delay followed by 1 call for a total of 4 cycles, which equates to 8 queue items. */
			equal($target1.queue().length, 8, "Loop call produced \"reverse\" calls.");

			setTimeout(function() {
				equal($target1.data(pluginName).opts.delay, testDelay, "Delay option was passed into second infinite loop call (jQuery object).");

				start();
			}, completeCheckDuration + testDelay);
		});

		/*******************
		   Option: Begin
		*******************/

		QUnit.asyncTest("Option: Begin", function () {
			expect(2);

			var $targetSet1 = getTarget().add(getTarget());
			$targetSet1.velocity(defaultProperties, { 
				duration: asyncCheckDuration,
				complete: function() {
					deepEqual(this, $targetSet1.get(), "Element Function: jQuery objects passed into callback.");
				}
			});

			var targetSet2 = getTarget().add(getTarget()).get();
			$.velocity.animate(targetSet2, defaultProperties, { 
				duration: asyncCheckDuration,
				complete: function() {
					deepEqual(this, targetSet2, "Utility function: Raw DOM elements passed into callback.");

					start();
				}
			});
		});

		/*********************
		   Option: Complete
		*********************/

		QUnit.asyncTest("Option: Complete", function () {
			expect(2);

			var $targetSet1 = getTarget().add(getTarget());
			$targetSet1.velocity(defaultProperties, { 
				duration: asyncCheckDuration,
				complete: function() {
					deepEqual(this, $targetSet1.get(), "Element Function: jQuery objects passed into callback.");
				}
			});

			var targetSet2 = getTarget().add(getTarget()).get();
			$.velocity.animate(targetSet2, defaultProperties, { 
				duration: asyncCheckDuration,
				complete: function() {
					deepEqual(this, targetSet2, "Utility function: Raw DOM elements passed into callback.");

					start();
				}
			});
		});

		/*********************
		   Command: Scroll
		*********************/

		/* Window scrolling. */
		QUnit.asyncTest("Command: Scroll (Window)", function () {
			var $details = $("#details"),
				$scrollTarget1 = $("<div>Scroll target #1. Should stop 50 pixels above this point.</div>"),
				$scrollTarget2 = $("<div>Scroll target #2. Should stop 50 pixels before this point.</div>"),
				scrollOffset = -50;

			$scrollTarget1
				.css({ position: "relative", top: 3000, height: 100, paddingBottom: 10000 })
				.appendTo($("body"));

			$scrollTarget2
				.css({ position: "absolute", top: 100, left: 3000, width: 100, paddingRight: 15000 })
				.appendTo($("body"));

			$scrollTarget1
				.velocity("scroll", { duration: 500, offset: scrollOffset, complete: function() {
						equal(Math.abs($.velocity.State.scrollAnchor[$.velocity.State.scrollPropertyTop] - ($scrollTarget1.offset().top + scrollOffset)) <= 100, true, "Page scrolled top with a scroll offset.");
					}
				})
				.velocity({ opacity: 0.5 }, function() {
				    $details
					    .velocity({ opacity: 0.5 }, 500)
					    .velocity("scroll", 500)
					    .velocity({ opacity: 1 }, 500, function() {
							equal(($.velocity.State.scrollAnchor[$.velocity.State.scrollPropertyTop] - ($scrollTarget1.offset().top + scrollOffset)) <= -100, true, "Page scroll top was chained.");

							$scrollTarget1.remove();

							$scrollTarget2
								.velocity("scroll", { duration: 500, axis: "x", offset: scrollOffset, complete: function() {
										/* Phones can reposition the browser's scroll position by a 10 pixels or so, so we just check for a value that's within that range. */
										equal(Math.abs($.velocity.State.scrollAnchor[$.velocity.State.scrollPropertyLeft] - ($scrollTarget2.offset().left + scrollOffset)) <= 100, true, "Page scrolled left with a scroll offset.");
									}
								})
								.velocity({ opacity: 0.5 }, function() {
								    $details
									    .velocity({ opacity: 0.5 }, 500)
									    .velocity("scroll", { duration: 500, axis: "x" })
									    .velocity({ opacity: 1 }, 500, function() {
											equal(($.velocity.State.scrollAnchor[$.velocity.State.scrollPropertyLeft] - ($scrollTarget2.offset().left + scrollOffset)) <= -100, true, "Page scroll left was chained.");
											start();
									    });
								});
					    });
				});
		});

		/* Element scrolling. */
		QUnit.asyncTest("Command: Scroll (Element)", function () {
			expect(2);

			var $scrollTarget1 = $("\
				<div id='scroller'>\
					aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\
					aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\
					aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\
					aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\
					aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\
					<div id='scrollerChild1'>\
						Stop #1\
						bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\
						bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\
						bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\
						bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\
						bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\
					</div>\
					cccccccccccccccccccccccccccccccccccccccccccccccccccccccc\
					cccccccccccccccccccccccccccccccccccccccccccccccccccccccc\
					cccccccccccccccccccccccccccccccccccccccccccccccccccccccc\
					cccccccccccccccccccccccccccccccccccccccccccccccccccccccc\
					cccccccccccccccccccccccccccccccccccccccccccccccccccccccc\
					<div id='scrollerChild2'>\
						Stop #2\
						dddddddddddddddddddddddddddddddddddddddddddddddddddddddd\
						dddddddddddddddddddddddddddddddddddddddddddddddddddddddd\
						dddddddddddddddddddddddddddddddddddddddddddddddddddddddd\
						dddddddddddddddddddddddddddddddddddddddddddddddddddddddd\
						dddddddddddddddddddddddddddddddddddddddddddddddddddddddd\
					</div>\
					eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\
					eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\
					eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\
					eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\
					eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\
				</div>\
			");

			$scrollTarget1
				.css({ position: "absolute", backgroundColor: "white", top: 100, left: "50%", width: 500, height: 100, overflowY: "scroll" })
				.appendTo($("body"));

			/* Test with a jQuery object container. */
			$("#scrollerChild1").velocity("scroll", { container: $("#scroller"), duration: 750, complete: function() {
					/* Test with a raw DOM element container. */
					$("#scrollerChild2").velocity("scroll", { container: $("#scroller")[0], duration: 750, complete: function() {
							/* This test is purely visual. */
							ok(true);

							$scrollTarget1.remove();

							var $scrollTarget2 = $("\
								<div id='scroller'>\
									<div id='scrollerChild1' style='float: left; width: 20%;'>\
										Stop #1\
										bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\
										bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\
										bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\
										bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\
										bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\
										cccccccccccccccccccccccccccccccccccccccccccccccccccccccc\
										cccccccccccccccccccccccccccccccccccccccccccccccccccccccc\
										cccccccccccccccccccccccccccccccccccccccccccccccccccccccc\
										cccccccccccccccccccccccccccccccccccccccccccccccccccccccc\
										cccccccccccccccccccccccccccccccccccccccccccccccccccccccc\
									</div>\
									<div id='scrollerChild2' style='float: right; width: 20%;'>\
										Stop #2\
										dddddddddddddddddddddddddddddddddddddddddddddddddddddddd\
										dddddddddddddddddddddddddddddddddddddddddddddddddddddddd\
										dddddddddddddddddddddddddddddddddddddddddddddddddddddddd\
										dddddddddddddddddddddddddddddddddddddddddddddddddddddddd\
										dddddddddddddddddddddddddddddddddddddddddddddddddddddddd\
										eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\
										eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\
										eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\
										eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\
										eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee\
									</div>\
								</div>\
							");

							$scrollTarget2
								.css({ position: "absolute", backgroundColor: "white", top: 100, left: "50%", width: 100, height: 500, overflowX: "scroll" })
								.appendTo($("body"));

							/* Test with a jQuery object container. */
							$("#scrollerChild2").velocity("scroll", { axis: "x", container: $("#scroller"), duration: 750, complete: function() {
									/* Test with a raw DOM element container. */
									$("#scrollerChild1").velocity("scroll", { axis: "x", container: $("#scroller")[0], duration: 750, complete: function() {
											/* This test is purely visual. */
											ok(true);

											$scrollTarget2.remove();

											start();
										}
									});
								}
							});
						}
					});
				}
			});
		});

		/*********************
		   Command: Reverse
		*********************/

		QUnit.asyncTest("Command: Reverse", function () {
			expect(5);

			var testEasing = "spring";

			var $target = getTarget();
			$target
				/* Ensure an error isn't thrown when there's no previous animation to reverse to. */
				.velocity("reverse")
				.velocity({ opacity: defaultProperties.opacity, width: defaultProperties.width }, { easing: testEasing })
				.velocity("reverse", function() {
					equal(parseFloat($target.css("opacity")), defaultStyles.opacity, "Reversed to initial property #1.");
					equal(parseFloat($target.css("width")), defaultStyles.width, "Reversed to initial property #2.");
				})
				/* Check chained reverses. */
				.velocity("reverse", function() {
					equal(parseFloat($target.css("opacity")), defaultProperties.opacity, "Reversed to reversed property #1.");
					equal(parseFloat($target.css("width")), defaultProperties.width, "Reversed to reversed property #2.");

					/* Ensure the options were passed through until the end. */
					equal($target.data(pluginName).opts.easing, testEasing, "Options object passed through.");

					start();
				});
		});

		/******************
		   Command: Stop
		******************/

		QUnit.test("Command: Stop", function () {
			var $target = getTarget();
			$target
				/* Ensure an error isn't thrown when "stop" is called on a $target that isn't animating. */
				.velocity("stop")
				.velocity(defaultProperties, 1)
				.velocity({ top: 0 })
				.velocity("stop");

			/* Ensure "stop" has removed all queued animations (without loop: false). */
			/* We're using the element's queue length as a proxy. 0 and 1 both mean that the element's queue has been cleared -- a length of 1 just indicates that the animation is in progress. */
			equal($target.queue().length <= 1, true, "Stopped queue length (loop: false).");

			/* Ensure "stop" has removed all queued animations (with looping). */
			$target
				.velocity(defaultProperties, { loop: true })
			 	.velocity("stop");

			equal($target.queue().length <= 1, true, "Stopped queue check (loop: true).");
		});

		/***********************
		   Feature: Sequences
		***********************/

		// pass in a second elem, pass in raw dom 
		QUnit.asyncTest("Feature: Sequences", function () {
			var $target1 = getTarget(),
				$target2 = getTarget(),
				sequenceOptions = { duration: 1500 };

			jQuery.velocity.Sequences.test = function (element, options, elementIndex, elementsLength) {
				if (elementIndex === 0) {
					deepEqual(element, $target1[0], "Element passed through #1.");
					deepEqual(options, sequenceOptions, "Options object passed through #1.");
					equal(elementIndex, 0, "Element index passed through #1.");
					equal(elementsLength, 2, "Elements length passed through #1.");
				} else if (elementIndex === 1) {
					deepEqual(element, $target2[0], "Element passed through #2.");
					deepEqual(options, sequenceOptions, "Options object passed through #2.");
					equal(elementIndex, 1, "Element index passed through #2.");
					equal(elementsLength, 2, "Elements length passed through #2.");

					start();
				}
			}

			$target1.add($target2).velocity("test", sequenceOptions);
		});

		/*********************
		   Feature: Classes
		*********************/

		// QUnit.test("Feature: Classes", function () {
		// 	$("head")
		// 		.append("<style>#testParent .animate_testCSSClass { opacity: 0.5; width: 100px; height: 10em; }</style>")
		// 		.append("<style>div.animate_testCSSClassMessy {opacity: 0.5;width: 100px; height:10em;}</style>")
		// 		.append("<style>.animate_testCSSIgnore #div { opacity: 0.5; width: 100px; height: 10em; }</style>");

		// 	var testCSSClass = { width: "100px", height: "10em", opacity: "0.5" },
		// 		extractedClasses = $.velocity.Classes.extract();

		// 	deepEqual(extractedClasses.testCSSClass, testCSSClass, "Class extraction: basic.");
		// 	deepEqual(extractedClasses.testCSSClassMessy, testCSSClass, "Class extraction: basic messy.");
		// 	equal(extractedClasses.testCSSClassIgnore, undefined, "Class extraction: Ignored non-final position match.");

		// 	var $target = getTarget();
		// 	$target
		// 		/* Ensure a class database miss doesn't throw an error. */
		// 		.velocity("fake")
		// 		.velocity("testCSSClass");

		// 	equal($target.data(pluginName).tweensContainer.width.endValue, parseFloat(testCSSClass.width), "Value #1 passed to tween.");
		// 	equal($target.data(pluginName).tweensContainer.height.endValue, parseFloat(testCSSClass.height), "Value #2 passed to tween.");
		// 	equal($target.data(pluginName).tweensContainer.opacity.endValue, parseFloat(testCSSClass.opacity), "Value #3 passed to tween.");
		// });

		/*****************************
		   Feature: Value Functions    
		*****************************/

		QUnit.test("Feature: Value Functions", function () {
			var testWidth = 10;

			var $target1 = getTarget();
			var $target2 = getTarget();
			$target1.add($target2).velocity({ width: function (i, total) { return (i + 1)/total * testWidth; } });

			equal($target1.data(pluginName).tweensContainer.width.endValue, parseFloat(testWidth) / 2, "Function value #1 passed to tween.");
			equal($target2.data(pluginName).tweensContainer.width.endValue, parseFloat(testWidth), "Function value #2 passed to tween.");
		});

		/***************************
		   Feature: Forcefeeding    
		***************************/

		QUnit.test("Feature: Forcefeeding", function () {
			/* Note: Start values are always converted into pixels. W test the conversion ratio we already know to avoid additional work. */
			var testStartWidth = "1rem", testStartWidthToPx = "16px",
				testStartHeight = "10px";

			var $target = getTarget();
			$target.velocity({ width: [ 100, "linear", testStartWidth ], height: [ 100, testStartHeight ], opacity: [ defaultProperties.opacity, "easeInQuad" ]});

			equal($target.data(pluginName).tweensContainer.width.startValue, parseFloat(testStartWidthToPx), "Forcefed value #1 passed to tween.");
			equal($target.data(pluginName).tweensContainer.height.startValue, parseFloat(testStartHeight), "Forcefed value #2 passed to tween.");
			equal($target.data(pluginName).tweensContainer.opacity.startValue, defaultStyles.opacity, "Easing was misinterpreted as forcefed value.");
		});
		</script>
	</body>
</html>